#!/usr/bin/env python
"""Apply a bad pixel map (pbm) to a DES image 
"""

# imports
from functools import partial
import ctypes
import sys
from os import path

import numpy as np

from pixcorrect import corr_util
from pixcorrect.corr_util import PrepMain, logger
from pixcorrect import proddir
from despyfits.DESImage import DESImage, DESImageCStruct

# constants

# Which section of the config file to read for this step
config_section = 'bpm'

# exception classes
# interface functions

def apply_bpm(image, bpm_im):
    """Apply a bad pixel mask to a DES image

    :Parameters:
        - `image`: the DESImage to which the BPM is to be applied
        - `bpm_im`: the DESImage with the bad pixel mask

    Applies the correction "in place"
    """

    logger.info('Applying BPM')
    bpm(image.cstruct, bpm_im.cstruct)
    logger.debug('Finished applying BPM')

# classes
# internal functions & classes

# Lowest level access to the C library function
bpm_lib = np.ctypeslib.load_library('libbpm.so', path.join(proddir, 'lib')) 
bpm = bpm_lib.bpm
bpm.restype = ctypes.c_int
bpm.argtypes = [DESImageCStruct, DESImageCStruct]

def apply_bpm_main(config):
    """A driver for applying the BPM

    :Parameters:
        -`config`: a python ConfigParsers object

    @returns: 0 if successful
    """
    # Load files and images here if we don't want
    # bias to clean up the memory, because other drivers that
    # call bias might want it for future steps.
    in_fname = config.get(config_section, 'in')
    im = DESImage.load(in_fname)

    bpm_fname = config.get(config_section, 'bpm')
    logger.info('reading BPM from %s' % bpm_fname)
    bpm_im = DESImage.load(bpm_fname)
    
    apply_bpm(im, bpm_im)

    out_fname = config.get(config_section, 'out')
    im.save(out_fname)

    return 0

def add_bpm_args(prep_main):
    prep_main.parser.add_argument('-i', '--in', nargs=1, 
                                  default=None,
                                  help='input image file name')
    prep_main.parser.add_argument('-b', '--bpm', nargs=1, 
                                  default=None, 
                                  help='bad pixel mask filename')
    prep_main.parser.add_argument('-o', '--out', nargs=1, 
                                  default=None,
                                  help='output image file name')

if __name__ == '__main__':
    prep_main = PrepMain(config_section, 'Apply a bad pixel mask')
    add_bpm_args(prep_main)
    config = prep_main()
    try:
        apply_bpm_main(config)
        sys.exit(0)
    except:
        # If we want to set specific exit status values
        # based on what exceptions get thrown, do that
        # here
        raise
