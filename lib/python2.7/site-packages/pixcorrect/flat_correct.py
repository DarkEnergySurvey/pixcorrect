#!/usr/bin/env python
"""Apply a flatfield"""

# imports
from functools import partial
import ctypes
import sys
from os import path

import numpy as np
import numpy.ma as ma

from pixcorrect import corr_util
from pixcorrect.harmonic_mean import harmonic_mean
from pixcorrect.corr_util import PrepMain, logger, do_once
from pixcorrect import proddir
from despyfits.DESImage import DESImage, DESDataImage, BADPIX_BPM

# constants

# Which section of the config file to read for this step
config_section = 'flat'

# exception classes
# interface functions

@do_once(0,'DESFLAT')
def flat_correct(image, config):
    """Apply operation flat correction to a DES image

    :Parameters:
        - `image`: the DESImage to be flat corrected
        - `config`: A python ConfigParser object

    Applies the correction "in place"
    """

    flat_fname = config.get(config_section, 'flat')
    flat_im = DESImage.load(flat_fname)
    image.header['FLATFIL'] = path.basename(flat_fname)

    # Use numpy masking to deal with 0s
    masked_image = ma.masked_array(image.data)
    masked_flat = ma.masked_array(flat_im.data)
    masked_image /= masked_flat

    masked_image[masked_image.mask] = 0.0
    image.weight[masked_image.mask] = 0.0
    image.mask[masked_image.mask] |= BADPIX_BPM

    logger.info('Completed flat')

# classes
# internal functions & classes

def flat_correct_main(config):
    """A driver for applying operation flat

    :Parameters:
        -`config`: a python ConfigParsers object

    @returns: 0 if successful
    """
    # Load files and images here if we don't want
    # flat to clean up the memory, because other drivers that
    # call flat might want it for future steps.
    in_fname = config.get(config_section, 'image_in_fname')
    im = DESImage.load(in_fname)

    flat_correct(im, config)

    out_fname = config.get(config_section, 'image_out_fname')
    im.save(out_fname, save_mask=False, save_weight=False)

    return 0

def add_flat_args(prep_main):
    prep_main.parser.add_argument('--image_in_fname', nargs=1, 
                                  default=None,
                                  help='input image file name')
    prep_main.parser.add_argument('--flat', nargs=1, 
                                  default=None, 
                                  help='flat filename')
    prep_main.parser.add_argument('--image_out_fname', nargs=1, 
                                  default=None,
                                  help='output image file name')
    prep_main.switch_opts['flat']=['image_in_fname', 
                                   'flat',
                                   'image_out_fname']

if __name__ == '__main__':
    prep_main = PrepMain(config_section, 'Apply a flat correction')
    add_flat_args(prep_main)
    config = prep_main()
    try:
        flat_correct_main(config)
        sys.exit(0)
    except:
        # If we want to set specific exit status values
        # based on what exceptions get thrown, do that
        # here
        raise
